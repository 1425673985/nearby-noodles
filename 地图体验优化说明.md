# 地图体验优化说明 - 距离感 + 决策效率

## 优化目标

让用户在第一眼就感知面馆"就在附近"，而不是在城区中。地图作为辅助信息，面馆卡片是主决策区域。

## 已实现的优化

### 1. 地图默认缩放策略 ✅

**自动聚焦用户+面馆位置**：
- 页面加载时，自动计算用户位置和面馆位置的边界
- 使用适合步行的缩放级别（15-18级）
- 确保两个点完整出现在视野内，同时能看到路口和行走方向

**缩放级别规则**：
- 200米以内：18级（最详细）
- 200-500米：17级
- 500米-1公里：16级
- 1公里以上：15级

**实现方法**：
- `calculateBoundsForWalking()` - 计算两点边界和合适缩放级别
- `focusOnUserAndRestaurant()` - 自动聚焦到推荐视图
- 使用 `includePoints` API 确保两个点都在视野内

### 2. 地图视觉权重调整 ✅

**弱化地图视觉**：
- 地图高度：500rpx → 400rpx（降低20%）
- 不透明度：0.85（作为背景层）
- 灰度滤镜：20%（轻微灰度，弱化视觉）
- 禁用POI和建筑物：`enable-poi="false"` `enable-building="false"`
- 隐藏指南针和比例尺：`show-compass="false"` `show-scale="false"`

**效果**：
- 地图不再抢占注意力
- 面馆信息卡片成为视觉焦点
- 保持地图简洁，只显示必要信息

### 3. 地图交互逻辑优化 ✅

**自动回到推荐视图**：
- 页面初始化时：自动聚焦用户+面馆
- 切换面馆时：自动聚焦用户+新面馆
- 点击定位按钮：恢复推荐视图

**实现位置**：
- `searchNearbyRestaurants()` - 搜索完成后自动聚焦
- `changeRestaurant()` - 切换面馆后自动聚焦
- `moveToUserLocation()` - 恢复推荐视图

### 4. 地图按钮策略调整 ✅

**定位用户按钮**：
- 默认隐藏：`showLocationBtn: false`
- 用户拖动地图时显示：监听 `bindregionchange`
- 用户缩放地图时显示：监听 `bindscalechange`
- 3秒无操作自动隐藏：使用定时器
- 点击按钮后隐藏：恢复推荐视图

**移除定位面馆按钮**：
- 已删除 `moveToRestaurant()` 方法
- 已移除UI中的定位面馆按钮
- 功能冗余已消除

**按钮显示逻辑**：
```javascript
// 用户操作地图时
showLocationButton() {
  this.setData({ showLocationBtn: true })
  // 3秒后自动隐藏
  setTimeout(() => {
    this.setData({ showLocationBtn: false })
  }, 3000)
}
```

### 5. 行为边界 ✅

- ✅ 不影响现有导航功能
- ✅ 不影响换一家功能
- ✅ 不引入新的复杂交互
- ✅ 仅修改当前项目代码

## 技术实现细节

### 核心方法

1. **calculateBoundsForWalking()**
   - 计算用户和面馆两点的边界
   - 根据距离范围确定合适的缩放级别
   - 添加40%边距，确保能看到路口

2. **focusOnUserAndRestaurant()**
   - 调用 `calculateBoundsForWalking()` 获取边界
   - 更新地图中心和缩放级别
   - 使用 `includePoints` API 确保两个点都在视野内

3. **showLocationButton()**
   - 显示定位按钮
   - 设置3秒定时器自动隐藏
   - 清除之前的定时器避免重复

### 地图事件监听

- `bindregionchange` - 监听地图拖动
- `bindscalechange` - 监听地图缩放
- 事件触发时显示定位按钮

### 样式优化

```css
.restaurant-map-wrapper {
  height: 400rpx; /* 降低高度 */
  opacity: 0.85; /* 降低不透明度 */
}

.restaurant-map {
  filter: grayscale(20%); /* 轻微灰度 */
}
```

## 用户体验提升

### 优化前
- ❌ 地图占据大量视觉空间
- ❌ 需要手动操作地图查看位置关系
- ❌ 按钮一直显示，干扰视觉
- ❌ 地图显示过多无关信息

### 优化后
- ✅ 地图自动聚焦，一眼看到位置关系
- ✅ 地图弱化，面馆卡片是焦点
- ✅ 按钮按需显示，不干扰
- ✅ 地图简洁，只显示必要信息
- ✅ 用户感知"就在附近"，而不是在城区中

## 测试建议

1. **自动聚焦测试**：
   - 打开小程序，观察地图是否自动聚焦
   - 切换面馆，观察是否自动聚焦到新位置

2. **按钮显示测试**：
   - 拖动地图，观察按钮是否出现
   - 等待3秒，观察按钮是否自动隐藏
   - 点击按钮，观察是否恢复推荐视图

3. **视觉权重测试**：
   - 观察地图是否弱化
   - 观察面馆卡片是否成为焦点
   - 检查地图高度是否降低

4. **缩放级别测试**：
   - 测试不同距离的面馆
   - 验证缩放级别是否合适
   - 确认能看到路口和行走方向

## 修改的文件

- `pages/index/index.js` - 添加自动聚焦逻辑和按钮控制
- `pages/index/index.wxml` - 修改地图属性和按钮显示逻辑
- `pages/index/index.wxss` - 弱化地图视觉权重

## 注意事项

1. **地图上下文初始化**：在首次聚焦时初始化 `mapContext`
2. **定时器清理**：页面卸载时清理定时器，避免内存泄漏
3. **API兼容性**：`includePoints` 在某些环境下可能失败，已添加降级处理
4. **性能优化**：使用 `setTimeout` 延迟聚焦，确保地图组件已渲染

